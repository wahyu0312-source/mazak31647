<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>出荷検査成績書（B83／3164-71）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- PDF libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    html, body { background:#e7e7e7; margin:0; padding:0; font-family:Arial,sans-serif; font-size:3.5mm; height:100%; }
    .no-print { display: initial; } .print-text { display: none; }
    input, select { font-size:3.2mm; padding:.5mm; box-sizing:border-box; font-family:Arial,sans-serif; }
    input[type="date"] { -webkit-appearance:none; appearance:none; line-height:1.2; }
    table input, table input[type="date"], .td-measure-grid input {
      border:none; outline:none; background:transparent; box-shadow:none; border-radius:0; padding:0 1mm;
      width:100%; height:100%; box-sizing:border-box; -webkit-appearance:none; appearance:none;
    }
    table input:focus, table input[type="date"]:focus { outline:none; box-shadow:none; }
    @media screen { html, body { display:flex; flex-direction:column; align-items:center; } .b5-preview { margin:12mm 0; } }
    .b5-preview { background:#fff; width:176mm; max-width:98vw; margin:10mm auto; padding:8mm; box-shadow:0 0 5mm rgba(0,0,0,.25); box-sizing:border-box; }
    h2 { text-align:center; font-size:7mm; margin-bottom:8mm; }

    table { width:100%; border-collapse:collapse; margin-bottom:4mm; }
    th, td { border:.3mm solid #333; padding:1.2mm 1mm; text-align:center; background:#fff; vertical-align:middle; }
    th { background:#fff; }
    .section-label { text-align:left; font-weight:bold; background:#fff; }

    .header-table td, .header-table th { white-space:nowrap; word-break:keep-all; }
    .header-table input { min-width:0; }
    .ta-left { text-align:left !important; }

    .td-judge { padding:0 !important; }
    .judge-grid { display:grid; grid-template-columns:1fr auto; align-items:center; gap:1mm; padding:0 1mm; }
    .judge-grid select { width:100%; }
    .judge-grid input[type="checkbox"] { margin:0 .5mm; }

    .td-measure { padding:0 !important; }
    .td-measure-grid { display:grid; grid-template-columns:1fr auto auto; align-items:center; gap:1mm; }
    .td-measure-grid input { text-align:right; }
    .td-measure-grid .measure-check { margin:0 .5mm; }

    .inputter-row { display:flex; align-items:center; gap:2mm; margin-bottom:3mm; }
    .inputter-row label { width:12mm; font-weight:bold; }
    .inputter-row select { width:30%; }

    .stamp-box-row { display:flex; justify-content:flex-end; gap:4mm; margin-top:3mm; }
    .stamp-box-row>div { display:flex; flex-direction:column; align-items:center; }
    .stamp-label { font-size:3mm; margin-bottom:1mm; text-align:center; }
    .signature-box {
      width:15mm; height:15mm; border:.3mm solid #333; border-radius:2mm;
      background:#fff; display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    .signature-box img { width:9mm; height:9mm; object-fit:contain; }

    .company-name { text-align:right; margin:2mm 1mm 0; font-weight:bold; }
    .order-no-row .section-label { width:15%; } .order-no-row .data { width:85%; }

    .toolbar { position:fixed; top:12px; left:50%; transform:translateX(-50%); display:flex; gap:8px; padding:8px 10px; background:rgba(255,255,255,0.92); border:1px solid #ddd; border-radius:12px; box-shadow:0 2px 18px rgba(0,0,0,.12); z-index:9999; backdrop-filter:blur(4px); }
    .toolbar button { font-family:Arial,sans-serif; font-size:14px; padding:8px 14px; border-radius:8px; border:1px solid #ccc; background:#fff; cursor:pointer; }
    .toolbar button:hover { filter:brightness(.96); }
    @media (max-width:560px){ .toolbar{ top:8px; gap:6px; padding:6px 8px; } .toolbar button{ padding:6px 10px; font-size:13px; } }

    @media print {
      /* Hide manual checkboxes on print */
      input[type="checkbox"] { display: none !important; }

      @page { size:B5 portrait; margin:12mm; }
      html, body { background:none !important; margin:0 !important; padding:0 !important; }
      .toolbar { display:none !important; }
      .b5-preview { width:100%; margin:0; padding:0; box-shadow:none; box-sizing:border-box; transform:scale(0.97); transform-origin:top left; }
      table { width:100%; }
      .no-print { display:none !important; }
      .print-text { display:inline !important; }
      table input, table input[type="date"], .td-measure-grid input {
        border:none !important; outline:none !important; background:transparent !important; box-shadow:none !important; border-radius:0 !important;
      }
      .signature-box img[src=""] { display:none !important; }
      .stamp-box-row, .signature-box { display:flex !important; }
      * { -webkit-print-color-adjust:exact; print-color-adjust:exact; }
    }

    .td-measure-grid input.invalid { background:#ffebee; box-shadow:inset 0 0 0 1px #d32f2f; }
    @media print { .td-measure-grid input.invalid { background:transparent !important; box-shadow:none !important; } }

    .serial-wrap { display:grid; grid-template-columns:auto 1fr; align-items:center; gap:1mm; }
    .serial-prefix { white-space:nowrap; }

    .soft-required.pending {
      background-color:#fff7cc;
      box-shadow:inset 0 0 0 1px #e5b200;
      transition:background-color .25s ease;
    }
    @media print { .soft-required.pending { background:transparent !important; box-shadow:none !important; } }

    
    /* --- Ensure checkboxes are visible on screen --- */
    table input[type="checkbox"],
    .judge-grid input[type="checkbox"],
    .td-measure-grid input[type="checkbox"]{
      -webkit-appearance: checkbox;
      appearance: checkbox;
      width: auto;
      height: auto;
      padding: 0;
      border: none;
      background: initial;
      box-shadow: none;
    }

    /* helper for print mirrors of selects */
    .print-value { min-width:10mm; display:inline-block; text-align:center; }
  </style>
 </head>
<body>
  <div class="toolbar">
    <button type="button" onclick="printViaPDF()">🖨️ 印刷</button>
    <button type="button" onclick="saveToNASFixed()">💾 NAS保存</button>
    <button type="button" onclick="clearAllFields()">🧹 全てクリア</button>
    <button type="button" onclick="configureNextSerial()">🔢 番号設定</button>
    <button type="button" onclick="configureDigits()">#️⃣ 桁数設定</button>
    <button type="button" onclick="pickFolder()">📁 フォルダ選択</button>
    <button type="button" onclick="adminUnlock()">🔓 ロック解除</button>
  </div>

  <div id="lock-overlay" style="position:fixed;inset:0;background:rgba(255,255,255,.9);display:none;align-items:center;justify-content:center;z-index:9998;text-align:center;padding:20mm;">
    <div style="max-width:120mm;line-height:1.6;font-size:4.5mm;color:#b91c1c;">
      <div style="font-weight:bold;font-size:5mm;margin-bottom:4mm;">このフォームは現在、他の端末で編集中です</div>
      別端末で保存/印刷が終わるまでお待ちください。<br/>（管理者が必要ならロックを解除できます）
    </div>
  </div>

  <form id="inspection-form">
    <div class="b5-preview">
      <h2>出荷検査成績書</h2>

      <table class="header-table">
        <tr>
         <td class="section-label">客先</td><td>ヤマザキマザック(株) 御中</td>
          <td class="section-label">管理No.</td><td class="ta-left">TTS60-01-686</td>
          <td class="section-label">発行年月日</td>
          <td class="ta-left">
            <input type="date" name="hakkohiduke" class="no-print" />
            <span class="print-text" data-from="hakkohiduke"></span>
          </td>
        </tr>

        <tr>
          <td class="section-label">機種</td><td class="ta-left">B83</td>
          <td class="section-label">品番</td><td>Z33TV015250</td>

          <td class="section-label">図番</td>
          <td><input type="text" name="zuban" value="3164-71" class="soft-required" data-soft-required="1" /></td>
        </tr>

        <tr>
          <td class="section-label">品名</td><td class="ta-left">X/Y軸カバーL(高圧クーラント対応)</td>
          <td class="section-label">製造日</td>
          <td class="ta-left">
            <input type="date" name="makingdate" class="no-print soft-required" data-soft-required="1" />
            <span class="print-text" data-from="makingdate"></span>
          </td>
          <td class="section-label">製造No</td>
          <td class="ta-left">
            <div class="serial-wrap no-print">
              <span class="serial-prefix" data-prefix>316471-</span>
              <input type="text" name="serial_no_suffix" inputmode="numeric" placeholder="0001" class="soft-required" data-soft-required="1" readonly />
            </div>
            <span class="print-text" data-serial-print></span>
          </td>
        </tr>
      </table>

      <div class="inputter-row no-print">
        <label>入力者</label>
        <select name="inputter" class="soft-required" data-soft-required="1">
          <option value="">- 選択してください -</option>
          <option value="長谷部">長谷部</option>
          <option value="都合">都合</option>
          <option value="石橋">石橋</option>
          <option value="ワーユ">ワーユ</option>
        </select>
      </div>

      <!-- 検査項目テーブル（判定: dropdown + checkbox + print mirror） -->
      <table>
        <tr><th>検査項目</th><th>規格</th><th>判定</th></tr>
        <tr>
          <td>本体取付け寸法</td><td>組立架台取付合わせ確認</td>
          <td class="td-judge">
            <div class="judge-grid">
              <select class="no-print judge" data-judge-row="1" data-print-target="judge_print_1">
                <option value="">-</option>
                <option>合</option>
                <option>否</option>
              </select>
              <input type="checkbox" class="judge-check" title="チェック"/>
            </div>
            <span class="print-text print-value" data-judge-print id="judge_print_1"></span>
          </td>
        </tr>
        <tr>
          <td>摺動テスト</td><td>摺動テスト走り・機能確認</td>
          <td class="td-judge">
            <div class="judge-grid">
              <select class="no-print judge" data-judge-row="2" data-print-target="judge_print_2">
                <option value="">-</option>
                <option>合</option>
                <option>否</option>
              </select>
              <input type="checkbox" class="judge-check" title="チェック"/>
            </div>
            <span class="print-text print-value" data-judge-print id="judge_print_2"></span>
          </td>
        </tr>
        <tr>
          <td>摺動時の異音</td><td>摺動テスト走り時異音の有無確認</td>
          <td class="td-judge">
            <div class="judge-grid">
              <select class="no-print judge" data-judge-row="3" data-print-target="judge_print_3">
                <option value="">-</option>
                <option>合</option>
                <option>否</option>
              </select>
              <input type="checkbox" class="judge-check" title="チェック"/>
            </div>
            <span class="print-text print-value" data-judge-print id="judge_print_3"></span>
          </td>
        </tr>
        <tr>
          <td>外観検査</td><td>キズ・バリの有無目視確認</td>
          <td class="td-judge">
            <div class="judge-grid">
              <select class="no-print judge" data-judge-row="4" data-print-target="judge_print_4">
                <option value="">-</option>
                <option>合</option>
                <option>否</option>
              </select>
              <input type="checkbox" class="judge-check" title="チェック"/>
            </div>
            <span class="print-text print-value" data-judge-print id="judge_print_4"></span>
          </td>
        </tr>
        <tr>
          <td>ワイパーの隙間</td><td>ワイパー材 t=0.05にて確認</td>
          <td class="td-judge">
            <div class="judge-grid">
              <select class="no-print judge" data-judge-row="5" data-print-target="judge_print_5">
                <option value="">-</option>
                <option>合</option>
                <option>否</option>
              </select>
              <input type="checkbox" class="judge-check" title="チェック"/>
            </div>
            <span class="print-text print-value" data-judge-print id="judge_print_5"></span>
          </td>
        </tr>
        <tr>
          <td>ベアリングの確認</td><td>ベアリング脱落確認</td>
          <td class="td-judge">
            <div class="judge-grid">
              <select class="no-print judge" data-judge-row="6" data-print-target="judge_print_6">
                <option value="">-</option>
                <option>合</option>
                <option>否</option>
              </select>
              <input type="checkbox" class="judge-check" title="チェック"/>
            </div>
            <span class="print-text print-value" data-judge-print id="judge_print_6"></span>
          </td>
        </tr>
        <tr>
          <td>皿ネジの出っ張り</td><td>表面の皿ネジの出っ張り確認</td>
          <td class="td-judge">
            <div class="judge-grid">
              <select class="no-print judge" data-judge-row="7" data-print-target="judge_print_7">
                <option value="">-</option>
                <option>合</option>
                <option>否</option>
              </select>
              <input type="checkbox" class="judge-check" title="チェック"/>
            </div>
            <span class="print-text print-value" data-judge-print id="judge_print_7"></span>
          </td>
        </tr>
      </table>

      <!-- 測定テーブル（checkbox 追加） -->
      <table>
        <tr><th>項目</th><th>基準値</th><th>測定値</th></tr>
        <tr><td>X ストローク(MAX)</td><td>312 mm以上</td>
          <td class="td-measure">
            <div class="td-measure-grid">
              <input type="text" inputmode="numeric" name="b_length_xmax" placeholder=">=312" data-min="312" class="soft-required" data-soft-required="1" />
              <span>mm</span>
              <input type="checkbox" class="measure-check" title="チェック"/>
            </div>
          </td></tr>
        <tr><td>X ストローク(MIN)</td><td>112.7 mm以下</td>
          <td class="td-measure">
            <div class="td-measure-grid">
              <input type="text" inputmode="numeric" name="a_length_xmin" placeholder="0-112.7" data-min="0" data-max="112.7" class="soft-required" data-soft-required="1" />
              <span>mm</span>
              <input type="checkbox" class="measure-check" title="チェック"/>
            </div>
          </td></tr>
        <tr><td>Y ストローク(MAX)</td><td>156 mm以上</td>
          <td class="td-measure">
            <div class="td-measure-grid">
              <input type="text" inputmode="numeric" name="b_length_ymin" placeholder=">=156" data-min="156" class="soft-required" data-soft-required="1" />
              <span>mm</span>
              <input type="checkbox" class="measure-check" title="チェック"/>
            </div>
          </td></tr>
        <tr><td>Y ストローク(MAX)</td><td>315 mm以下</td>
          <td class="td-measure">
            <div class="td-measure-grid">
              <input type="text" inputmode="numeric" name="a_length_ymax" placeholder="0-315" data-min="0" data-max="315" class="soft-required" data-soft-required="1" />
              <span>mm</span>
              <input type="checkbox" class="measure-check" title="チェック"/>
            </div>
          </td></tr>
        <tr><td>初期摺動抵抗</td><td>7.0 kg以下</td>
          <td class="td-measure">
            <div class="td-measure-grid">
              <input type="text" inputmode="decimal" step="0.1" name="start_resist" placeholder="0-7.0" data-min="0" data-max="7" class="soft-required" data-soft-required="1" />
              <span>kg</span>
              <input type="checkbox" class="measure-check" title="チェック"/>
            </div>
          </td></tr>
        <tr><td>中期摺動抵抗</td><td>7.0 kg以下</td>
          <td class="td-measure">
            <div class="td-measure-grid">
              <input type="text" inputmode="decimal" step="0.1" name="mid_resist" placeholder="0-7.0" data-min="0" data-max="7" class="soft-required" data-soft-required="1" />
              <span>kg</span>
              <input type="checkbox" class="measure-check" title="チェック"/>
            </div>
          </td></tr>
      </table>

      <div style="margin:2mm 0;">
        <label style="font-weight:bold;">総合判定</label>
        <select name="final_judgment" class="no-print" style="margin-left:20mm;" disabled>
          <option>合格</option><option>否</option>
        </select>
        <span class="print-text" data-from-select="final_judgment"></span>
      </div>

      <div style="margin:2mm 0;">
        <label style="font-weight:bold;">[備考]</label>
        <input type="text" name="bikou" style="width:70%;" />
      </div>

      <div class="company-name">東京精密発條株式会社</div>
      <div class="stamp-box-row">
        <div>
          <select class="no-print" id="stamp1_sel" onchange="updateStampPreview('stamp1',this.value)">
            <option value="">- 印鑑選択 -</option>
            <option value="nakagawa.png">中川部長</option>
            <option value="hasebe.png">長谷部</option>
            <option value="ishibashi.png">石橋</option>
            <option value="togo.png">都合</option>
            <option value="wahyu.png">ワーユ</option>
            <option value="yusuf.png">ユスフ</option>
          </select>
          <div class="stamp-label">検印</div>
          <div class="signature-box"><img id="stamp1" src="" alt=""></div>
        </div>
        <div>
          <select class="no-print" id="stamp2_sel" onchange="updateStampPreview('stamp2',this.value)" disabled>
            <option value="">- 印鑑選択 -</option>
            <option value="nakagawa.png">中川部長</option>
            <option value="hasebe.png">長谷部</option>
            <option value="ishibashi.png">石橋</option>
            <option value="togo.png">都合</option>
            <option value="wahyu.png">ワーユ</option>
            <option value="yusuf.png">ユスフ</option>
          </select>
          <div class="stamp-label">検査印</div>
          <div class="signature-box"><img id="stamp2" src="" alt=""></div>
        </div>
      </div>
    </div>
  </form>

  <script>
    /* ===== CONFIG ===== */
    const APP_NS  = 'B83';
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzVgHHvdizqFzkejzMsCwrAmGtFvmkoUPJwQT_rtWi3Twsg6xoaGpT0IkvUIbe82Q90hA/exec';
    const ACTIVE_PREFIX_KEY = 'kensa_prefix'; // admin override
    const serverPrefix = () => `${APP_NS}::${getSerialPrefix()}`;
    const SERIAL_SCOPE = () => `okuma:serial:${APP_NS}:${getSerialPrefix() || '316471-'}`;
    let PAD_DIGITS = 4;

    /* ===== UI helpers ===== */
    function updateStampPreview(id, src){ document.getElementById(id).src = src || ''; }
    function clearAllFields(){
      const form = document.getElementById('inspection-form');
      const keepPrefix = getSerialPrefix();
      const keepSuffixRaw = (document.querySelector('input[name="serial_no_suffix"]')?.value || '');
      const keepSuffixNum = parseInt(keepSuffixRaw.replace(/[^\d]/g,''), 10);

      form.reset();
      ['stamp1','stamp2'].forEach(id => document.getElementById(id).src = '');
      form.querySelectorAll('.td-measure-grid input.invalid').forEach(el => el.classList.remove('invalid'));

      wireDateMirror(); wireEnterNavigationAll(); wireSerialMirror(); wireSoftRequired(); markSoftRequired(); mirrorAllSelectsToPrint();
      setTodayIfEmpty('hakkohiduke');

      const span = document.querySelector('.serial-prefix');
      if (span && keepPrefix) span.textContent = keepPrefix;
      if (Number.isFinite(keepSuffixNum)) setSerialSuffix(keepSuffixNum);

      updateSerialPrint();
      // keep initial disabled state for 検査印
      document.getElementById('stamp2_sel').disabled = true;
      evaluateAll();
    }
 async function postLog(action, notes=''){
    const q = s => document.querySelector(s);
    const serialPrefix = (q('.serial-prefix')?.textContent || '').trim();
    const serialSuffix = (q('input[name="serial_no_suffix"]')?.value || '').trim();
    const serialFull   = (typeof getSerialFull === 'function') ? getSerialFull() : (serialPrefix + serialSuffix);
    const zuban    = (q('input[name="zuban"]')?.value || '').trim();
    const customer = (document.querySelector('.header-table tr:nth-child(1) td:nth-child(2)')?.textContent || '').trim();
    const orderNo  = (q('input[name="order_no"]')?.value || '').trim();
    const inputter = (q('select[name="inputter"]')?.value || '').trim();
    const fileName = (typeof computeFilename === 'function') ? computeFilename() : '';
    const clientId = (localStorage.getItem('okuma:clientId') || '');

    try{
      await fetch(GAS_URL, {
        method:'POST',
        headers:{ 'Content-Type':'text/plain;charset=utf-8' },
        body: JSON.stringify({
          action:'logSave',
          app_ns: (typeof APP_NS!=='undefined'? APP_NS : ''),
          serial_prefix: serialPrefix,
          serial_suffix: serialSuffix,
          serial_full: serialFull,
          zuban, customer, order_no: orderNo, inputter,
          action, file_name: fileName, client_id: clientId, notes
        })
      });
    }catch(e){ console.warn('logSave failed:', e); }
  }
    /* ===== numeric guards ===== */
    (function wireMeasureValidation(){
      const fields = document.querySelectorAll('.td-measure-grid input[type="text"]');
      const normalize = s => s.replace(/[，,]/g,'.').replace(/[．｡。]/g,'.');
      fields.forEach(inp=>{
        const allowDec = (inp.getAttribute('step')||'').includes('.');
        const MAX_INT_DIGITS = 6;
        inp.addEventListener('input',()=>{
          let v = normalize(inp.value).replace(/[^\d.]/g,'');
          if((v.match(/\./g)||[]).length>1){ const [h,...r]=v.split('.'); v=h+'.'+r.join('').replace(/\D/g,''); }
          if(v.includes('.')){ let[d='',f='']=v.split('.'); d=d.slice(0,MAX_INT_DIGITS);
            v = allowDec ? (f===''?`${d}.`:`${d}.${(f||'').replace(/\D/g,'').slice(0,1)}`) : d;
          } else v=v.slice(0,MAX_INT_DIGITS);
          inp.value=v; inp.classList.remove('invalid');
        });
        inp.addEventListener('blur',()=>{
          let v = normalize(inp.value);
          if(v===''){ inp.classList.remove('invalid'); markSoftRequired(); evaluateAll(); return; }
          if(allowDec && /\.$/.test(v)) v=v.replace(/\.$/,'.0');
          const n=parseFloat(v), min=parseFloat(inp.dataset.min ?? '-Infinity'), max=parseFloat(inp.dataset.max ?? 'Infinity');
          const ok=!Number.isNaN(n)&&n>=(Number.isFinite(min)?min:-Infinity)&&n<=(Number.isFinite(max)?max:Infinity);
          if(!ok){ inp.value=''; inp.classList.add('invalid'); markSoftRequired(); evaluateAll(); return; }
          inp.value = allowDec ? n.toFixed(1).replace(/\.0$/,'.0') : String(Math.trunc(n)).slice(0,MAX_INT_DIGITS);
          inp.classList.remove('invalid'); markSoftRequired(); evaluateAll();
        });
        inp.addEventListener('input', ()=>{ markSoftRequired(); evaluateAll(); });
      });
    })();

    /* ===== navigation & mirrors ===== */
    function wireEnterNavigationAll(){
      const form=document.getElementById('inspection-form');
      const getFields=()=>Array.from(form.querySelectorAll('input, select, textarea')).filter(el=>!el.disabled && el.type!=='hidden' && el.offsetParent!==null);
      const move=(from,dir=+1)=>{const list=getFields(); const i=list.indexOf(from); if(i===-1) return; let j=i+dir; if(j>=list.length) j=0; if(j<0) j=list.length-1; const next=list[j]; next?.focus?.(); if(next && next.tagName==='INPUT' && !['checkbox','radio','file'].includes(next.type)) next.select?.();};
      getFields().forEach(el=>{
        if(el.dataset.enterNavWired==='1') return; el.dataset.enterNavWired='1';
        el.addEventListener('keydown',e=>{ if(e.isComposing||e.keyCode===229) return; if(e.key==='Enter'){ e.preventDefault(); move(el,e.shiftKey?-1:+1);} });
      });
    }
    function wireDateMirror(){
      document.querySelectorAll('input[type="date"]').forEach(inp=>{
        const span=document.querySelector(`.print-text[data-from="${inp.name}"]`); if(!span) return;
        const fmt=v=>v?v.replace(/(\d{4})-(\d{2})-(\d{2})/,'$1/$2/$3'):''; const upd=()=>span.textContent=fmt(inp.value);
        inp.addEventListener('change',()=>{ upd(); markSoftRequired(); }); upd();
      });
    }
    function mirrorAllSelectsToPrint(){
      document.querySelectorAll('select.no-print[data-print-target]').forEach(sel=>{
        const id=sel.getAttribute('data-print-target'); const out=document.getElementById(id); if(!out) return;
        const update=()=>{ out.textContent = sel.value || ''; };
        sel.addEventListener('change', update); update();
      });
      document.querySelectorAll('span.print-text[data-from-select]').forEach(span=>{
        const name = span.getAttribute('data-from-select'); const sel = document.querySelector(`select[name="${name}"]`);
        if(!sel) return; const upd=()=>span.textContent = sel.value || ''; sel.addEventListener('change', upd); upd();
      });
    }
    function markSoftRequired(){
      document.querySelectorAll('[data-soft-required]').forEach(el=>{
        let filled = true;
        if (el.tagName === 'SELECT') filled = !!el.value;
        else if (el.type === 'date' || el.type === 'text') filled = !!(el.value||'').trim();
        if (el.classList.contains('invalid')) filled = false;
        el.classList.toggle('pending', !filled);
      });
    }
    function wireSoftRequired(){
      document.querySelectorAll('[data-soft-required]').forEach(el=>{
        if (el.dataset.softReqWired === '1') return;
        el.dataset.softReqWired = '1';
        el.addEventListener('input',  markSoftRequired);
        el.addEventListener('change', markSoftRequired);
      });
    }

    /* ===== 判定 dropdown wiring ===== */
    function wireJudgeDropdowns(){
      document.querySelectorAll('select.judge').forEach(sel=>{
        if (sel.dataset.judgeWired === '1') return;
        sel.dataset.judgeWired = '1';
        const printTarget = sel.getAttribute('data-print-target');
        const out = printTarget ? document.getElementById(printTarget) : null;
        const updatePrint = ()=>{ if(out) out.textContent = sel.value || ''; };
        sel.addEventListener('change', ()=>{ updatePrint(); evaluateAll(); });
        updatePrint();
      });
      // manual checklist wiring (no logic impact)
      document.querySelectorAll('.judge-check').forEach(chk=>{
        if (chk.dataset.judgeCheckWired === '1') return;
        chk.dataset.judgeCheckWired = '1';
        chk.addEventListener('change', ()=>{});
      });
    }

    /* ===== Serial / Prefix ===== */
    function getActivePrefix(){ return (localStorage.getItem(ACTIVE_PREFIX_KEY) || '').trim(); }
    const getSerialPrefix = () => document.querySelector('.serial-prefix')?.textContent?.trim() || '';
    const getZuban = () => (document.querySelector('input[name="zuban"]').value || '').trim();

    function computePrefixFromZuban(z){
      const m = String(z||'').replace(/\D/g,'').match(/^(\d{6})/);
      return m ? `${m[1]}-` : '';
    }
    function prefixReady(){ return /^\d{6}-$/.test(getSerialPrefix()); }

    (function cleanBadAdminPrefix(){
      const ap = localStorage.getItem(ACTIVE_PREFIX_KEY);
      if (ap && !/^\d{6}-$/.test(ap)) localStorage.removeItem(ACTIVE_PREFIX_KEY);
    })();

    function applyPrefix(){
      const span = document.querySelector('.serial-prefix'); if(!span) return;
      const adminPref = getActivePrefix();
      const valid = /^\d{6}-$/.test(adminPref);

      if (valid) {
        span.textContent = adminPref;
      } else {
        if (adminPref) localStorage.removeItem(ACTIVE_PREFIX_KEY);
        const pref = computePrefixFromZuban(getZuban());
        span.textContent = pref;
      }
      updateSerialPrint();
    }

    window.addEventListener('storage', (e)=>{ if(e.key === ACTIVE_PREFIX_KEY){ applyPrefix(); } });

    const getSerialFull = () => {
      const p = getSerialPrefix();
      const s = (document.querySelector('input[name="serial_no_suffix"]').value || '').replace(/[^\d]/g,'').trim();
      return s ? (p + s) : p;
    };
    function updateSerialPrint(){
      const out = document.querySelector('[data-serial-print]');
      if (out) out.textContent = getSerialFull();
    }
    function formatSuffix(num){ const s = String(num); return s.length >= PAD_DIGITS ? s : ('0'.repeat(PAD_DIGITS - s.length) + s); }
    function setSerialSuffix(num){
      const s = formatSuffix(num);
      const inp = document.querySelector('input[name="serial_no_suffix"]'); if(!inp) return;
      inp.value = s; inp.dispatchEvent(new Event('input', { bubbles:true })); markSoftRequired(); updateSerialPrint();
    }
    function wireSerialMirror(){
      const out = document.querySelector('[data-serial-print]');
      const inp = document.querySelector('input[name="serial_no_suffix"]');
      if (!out) return; const upd = () => { out.textContent = getSerialFull(); }; inp?.addEventListener('input', upd); upd();
    }

    /* ===== GAS API ===== */
    async function apiGAS(body){
      const res = await fetch(GAS_URL, { method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8' }, body: JSON.stringify(body) });
      if(!res.ok) throw new Error('GAS HTTP '+res.status);
      return await res.json();
    }
    async function getNextSuffixShared(prefix){ const data = await apiGAS({ action:'nextSuffix', prefix }); if(typeof data?.suffix !== 'number') throw new Error('Bad nextSuffix'); return data.suffix; }
    async function setNextSuffixShared(prefix, next){ const data = await apiGAS({ action:'setNext', prefix, next }); if(data?.ok !== true) throw new Error('Bad setNext'); return true; }
    async function setDigitsShared(prefix, digits){ const data = await apiGAS({ action:'setDigits', prefix, digits }); if(data?.ok !== true) throw new Error('Bad setDigits'); return true; }
    async function getInfoShared(prefix){ const data = await apiGAS({ action:'getInfo', prefix }); return data; }

    async function assignNextSerialSuffix(){
      if(!prefixReady()){
        alert('製造Noのプレフィックス（6桁）が必要です（例: 282520-）。\n図番またはAdmin Prefixを確認してください。');
        return;
      }
      const prefix = serverPrefix();
      try{
        const nxt = await getNextSuffixShared(prefix);
        const KEY = `${SERIAL_SCOPE()}:lastSuffix`;
        localStorage.setItem(KEY, String(nxt));
        setSerialSuffix(nxt);
        return;
      }catch(e){ /* fallback local */ }
      const KEY = `${SERIAL_SCOPE()}:lastSuffix`;
      const next = await (async()=>{
        const last = parseInt(localStorage.getItem(KEY) || '0', 10) || 0;
        const nxt = last + 1; localStorage.setItem(KEY, String(nxt)); return nxt;
      })();
      setSerialSuffix(next);
    }

    /* ===== Lock ===== */
    const LOCK_TTL_SEC = 120; let __lockId = null; let __lockTimer = null; let __adminUnlocked = false;
    function getClientId(){ const k='okuma:clientId'; let id=localStorage.getItem(k); if(!id){ id=crypto.randomUUID(); localStorage.setItem(k,id);} return id; }
    function setEditingEnabled(enabled){ const disabled = !enabled; const form=document.getElementById('inspection-form'); form.querySelectorAll('input,select,textarea,button').forEach(el=>{ el.disabled = disabled; }); }
    function showLockOverlay(show){ const ov=document.getElementById('lock-overlay'); if(ov){ ov.style.display = show? 'flex':'none'; } }
    async function acquireSharedLock(prefix){
      try{
        const data = await apiGAS({ action:'acquireLock', prefix, clientId:getClientId(), ttlSec:LOCK_TTL_SEC });
        if(data?.ok){ __lockId = data.lockId || 'local'; heartbeatLock(prefix); return true; }
        return false;
      }catch(e){ return true; }
    }
    function heartbeatLock(prefix){
      if(__lockTimer) clearInterval(__lockTimer); if(!__lockId) return;
      __lockTimer = setInterval(async()=>{ try{ await apiGAS({ action:'extendLock', lockId:__lockId, prefix, clientId:getClientId(), ttlSec:LOCK_TTL_SEC }); }catch(e){} }, 60000);
    }
    async function releaseSharedLock(){
      if(!__lockId) return;
      try{ await apiGAS({ action:'releaseLock', lockId:__lockId, clientId:getClientId() }); }catch(e){}
      __lockId=null; if(__lockTimer){ clearInterval(__lockTimer); __lockTimer=null; }
    }
    async function ensureHasLockOrAcquire(){
      if(__adminUnlocked) { showLockOverlay(false); setEditingEnabled(true); return true; }
      if (!prefixReady()) { applyPrefix(); if (!prefixReady()) return false; }
      const prefix = serverPrefix();
      if(__lockId) return true;
      const ok = await acquireSharedLock(prefix);
      if(!ok){ showLockOverlay(true); setEditingEnabled(false); }
      else { showLockOverlay(false); setEditingEnabled(true); }
      return ok;
    }
    function adminUnlock(){
      __adminUnlocked = true;
      showLockOverlay(false);
      setEditingEnabled(true);
      releaseSharedLock();
      alert('ロックを解除しました（管理者）。編集可能です。');
    }

    /* ===== PDF ===== */
    const sanitize = s => (s||'').replace(/[\\/:*?"<>|]/g,'').trim();
    function nowHHMM(){ const t=new Date(); return String(t.getHours()).padStart(2,'0')+String(t.getMinutes()).padStart(2,'0'); }
    function computeFilename(){
      const md=document.querySelector('input[name="makingdate"]').value;
      const ymd = md ? md.replace(/-/g,'') : (()=>{const t=new Date(); return t.getFullYear()+String(t.getMonth()+1).padStart(2,'0')+String(t.getDate()).padStart(2,'0');})();
      const hm = nowHHMM();
      const customer = sanitize(document.querySelector('.header-table tr:nth-child(1) td:nth-child(2)')?.textContent || 'no-customer');
      const zuban    = sanitize(document.querySelector('input[name="zuban"]').value || 'no-zuban');
      const inputter = sanitize(document.querySelector('select[name="inputter"]').value || 'no-name');
      const orderNo  = sanitize(document.querySelector('input[name="order_no"]').value || 'no-order');
      const serialNo = sanitize(getSerialFull() || 'no-serial');
      return `${ymd}-${hm}_${customer}_${zuban}_${inputter}_${orderNo}_${serialNo}.pdf`;
    }
    async function renderFormCanvas(){
      const el=document.querySelector('.b5-preview');
      return html2canvas(el,{ scale:2, backgroundColor:'#FFFFFF', useCORS:true,
        onclone:(doc)=>{ doc.querySelectorAll('.no-print').forEach(e=>e.style.display='none'); doc.querySelectorAll('.print-text').forEach(e=>e.style.display='inline'); }});
    }
    async function buildPdfDoc(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation:'portrait', unit:'mm', format:'b5' });
      const canvas = await renderFormCanvas();
      doc.addImage(canvas.toDataURL('image/png'), 'PNG', 7, 7, 162, 236);
      return doc;
    }
    async function printViaPDF(){
      if (window.__busy) return;
      window.__busy = true;
      try{
        const ok = await ensureHasLockOrAcquire();
        if(!ok){ alert('現在ほかの端末が使用中のため、印刷できません。'); return; }
        await assignNextSerialSuffix();
        const doc = await buildPdfDoc();
        if(doc.autoPrint) doc.autoPrint();
        const blobUrl = doc.output('bloburl');
        window.open(blobUrl, '_blank');
        postLog('PRINT');
      } finally {
        window.__busy = false;
      }
    }

    /* ===== Save to NAS (Y軸) ===== */
    const DB_NAME='form-folder-db', STORE='folders'; let __db;
    const FOLDER_KEY = `okuma:${APP_NS}:y`;
    function openDB(){ return new Promise((resolve,reject)=>{ const req=indexedDB.open(DB_NAME,1); req.onupgradeneeded=()=>req.result.createObjectStore(STORE); req.onsuccess=()=>{ __db=req.result; resolve(); }; req.onerror=()=>reject(req.error); });}
    async function openDBIfNeeded(){ if(!__db) await openDB(); }
    async function putHandle(key, handle){ await openDBIfNeeded(); return new Promise((res,rej)=>{ const tx=__db.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(handle,key); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }
    async function getHandle(key){ await openDBIfNeeded(); return new Promise((res,rej)=>{ const tx=__db.transaction(STORE,'readonly'); const r=tx.objectStore(STORE).get(key); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); }); }
    async function serialExists(dir, prefix, numeric){
      if(!dir?.entries) return false;
      const pattern = new RegExp(`_${prefix}0*${numeric}\\.pdf$`);
      for await (const [name] of dir.entries()){
        if(/\.pdf$/i.test(name) && pattern.test(name)) return name;
      }
      return false;
    }
    async function pickFolder(){
      try{
        const dir = await window.showDirectoryPicker({ mode:'readwrite' });
        await navigator.storage?.persist?.();
        await putHandle(FOLDER_KEY, dir);
        alert(`フォルダを設定しました（キー: ${FOLDER_KEY}）`);
      }catch(e){ console.warn('Folder pick cancelled/failed:', e); }
    }
    async function ensureDir(){
      let dir = await getHandle(FOLDER_KEY);
      if (!dir) { await pickFolder(); dir = await getHandle(FOLDER_KEY); }
      return dir || null;
    }
    async function saveToNASFixed(){
      if (window.__busy) return;
      window.__busy = true;
      try{
        const ok = await ensureHasLockOrAcquire();
        if(!ok){ alert('現在ほかの端末が使用中のため、保存できません。'); return; }
        await assignNextSerialSuffix();
        const fileName = computeFilename();
        if(!window.showDirectoryPicker){
          const doc = await buildPdfDoc(); doc.save(fileName);
          postLog('SAVE','fallback-download');
          return;
        }
        try{
          let dir = await ensureDir();
          if(!dir){
            const doc = await buildPdfDoc(); doc.save(fileName);
            postLog('SAVE','fallback-download-no-dir');
            return;
          }
          let perm = await dir.queryPermission?.({ mode:'readwrite' });
          if(perm!=='granted'){
            perm = await dir.requestPermission?.({ mode:'readwrite' });
            if(perm!=='granted'){
              const doc = await buildPdfDoc(); doc.save(fileName);
              postLog('SAVE','fallback-download-no-permission');
              return;
            }
          }
          const rawPrefix = getSerialPrefix();
          const suffixStr = (document.querySelector('input[name="serial_no_suffix"]').value || '').trim();
          const numeric = parseInt(suffixStr.replace(/^0+/,'') || '0', 10);
          const dupe = await serialExists(dir, sanitize(rawPrefix), numeric);
          if(dupe){ alert(`同じ製造Noのファイルが既に存在します:\n${dupe}\n保存を中止しました。`); return; }
          const doc = await buildPdfDoc();
          const fh = await dir.getFileHandle(fileName, { create:true });
          const w = await fh.createWritable();
          await w.write(doc.output('blob')); await w.close();
          const t=new Date();
          alert(`保存しました: ${fileName}\n時刻: ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`);
          postLog('SAVE');
        }catch(e){
          console.error('NAS write failed; fallback to download.', e);
          const doc = await buildPdfDoc(); doc.save(fileName);
          postLog('SAVE','fallback-download-error');
        }
      } finally {
        window.__busy = false;
      }
    }

    /* ===== Auto rules: 総合判定 & 検査印 ===== */
    function allJudgesOK(){
      const sels = Array.from(document.querySelectorAll('select.judge'));
      if (sels.length === 0) return false;
      return sels.every(s => s.value === '合');
    }
    function allMeasuresOK(){
      const ins = Array.from(document.querySelectorAll('.td-measure-grid input[type="text"]'));
      if (ins.length === 0) return false;
      return ins.every(inp => (inp.value || '').trim() !== '' && !inp.classList.contains('invalid'));
    }
    const INPUTTER_TO_STAMP = {
      '中川部長':'nakagawa.png',
      '長谷部':'hasebe.png',
      '石橋':'ishibashi.png',
      '都合':'togo.png',
      'ワーユ':'wahyu.png',
      'ユスフ':'yusuf.png'
    };
    function autoPickKensaIn(){
      const inputterSel = document.querySelector('select[name="inputter"]');
      const stampSel = document.getElementById('stamp2_sel');
      if(!stampSel) return;
      const who = inputterSel?.value || '';
      const file = INPUTTER_TO_STAMP[who] || '';
      if (file){
        stampSel.value = file;
        stampSel.dispatchEvent(new Event('change', {bubbles:true}));
      }
    }
    
    function evaluateAll(){
      const finalSel = document.querySelector('select[name="final_judgment"]');
      const kensaSel = document.getElementById('stamp2_sel');

      const judgeSels = Array.from(document.querySelectorAll('select.judge'));
      const measureIns = Array.from(document.querySelectorAll('.td-measure-grid input[type="text"]'));

      const judgesFilled = judgeSels.every(s => (s.value||'') !== '');
      const judgesAllOK  = judgeSels.length>0 && judgeSels.every(s => s.value === '合');

      const measuresFilled = measureIns.every(inp => (inp.value||'').trim() !== '');
      const measuresValid  = measureIns.every(inp => !inp.classList.contains('invalid'));

      // 総合判定: 全て入力済みなら自動評価。未入力がある場合は変更しない
      if (finalSel){
        if (judgesFilled && measuresFilled && measuresValid){
          finalSel.value = judgesAllOK ? '合格' : '否';
        }
        finalSel.disabled = false;
        finalSel.dispatchEvent(new Event('change', {bubbles:true}));
      }

      // 検査印: 総合判定が「合格」になったら有効化し自動選択
      if (kensaSel){
        const passed = (judgesFilled && measuresFilled && measuresValid && judgesAllOK);
        const wasDisabled = kensaSel.disabled;
        kensaSel.disabled = !passed;
        if (passed && (wasDisabled || !kensaSel.value)){
          autoPickKensaIn();
        }
      }
    }
    }

    /* ===== INIT & Admin ===== */
    window.addEventListener('load', async () => {
      wireDateMirror(); wireEnterNavigationAll(); wireSerialMirror();
      setTodayIfEmpty('hakkohiduke');
      applyPrefix();
      wireSoftRequired(); markSoftRequired();
      wireJudgeDropdowns(); mirrorAllSelectsToPrint();

      document.querySelectorAll('.td-measure-grid .measure-check').forEach(chk=>{
        if (chk.dataset.wired === '1') return;
        chk.dataset.wired = '1';
        chk.addEventListener('change', ()=>{});
      });

      document.querySelector('input[name="zuban"]')?.addEventListener('change', async ()=>{
        applyPrefix();
        try{
          const info = await getInfoShared(serverPrefix());
          if (typeof info?.digits === 'number' && info.digits >= 1) PAD_DIGITS = info.digits;
        }catch(e){}
      });

      try{
        const info = await getInfoShared(serverPrefix());
        if (typeof info?.digits === 'number' && info.digits >= 1) PAD_DIGITS = info.digits;
      }catch(e){}

      document.getElementById('stamp2_sel').disabled = true;
      document.querySelector('select[name="inputter"]')?.addEventListener('change', ()=>{ evaluateAll(); });


      // Re-evaluate whenever measure inputs change
      document.querySelectorAll('.td-measure-grid input[type="text"]').forEach(inp=>{
        inp.addEventListener('change', evaluateAll);
        inp.addEventListener('input', evaluateAll);
      });
      // Re-evaluate when 判定 dropdowns change
      document.querySelectorAll('select.judge').forEach(sel=>{
        sel.addEventListener('change', evaluateAll);
      });
      await ensureHasLockOrAcquire();
      evaluateAll();
    });

    function setTodayIfEmpty(name){
      const inp = document.querySelector(`input[name="${name}"]`); if(!inp) return;
      if(!inp.value){
        const t=new Date(); const yyyy=t.getFullYear(), mm=String(t.getMonth()+1).padStart(2,'0'), dd=String(t.getDate()).padStart(2,'0');
        inp.value = `${yyyy}-${mm}-${dd}`; inp.dispatchEvent(new Event('change',{bubbles:true}));
      }
    }
    window.addEventListener('beforeunload', releaseSharedLock);

    async function configureNextSerial(){
      if(!prefixReady()){ alert('製造Noのプレフィックス（6桁）が必要です。'); return; }
      const prefix = serverPrefix();
      try{
        const info = await getInfoShared(prefix);
        const curNext = (typeof info?.next === 'number') ? info.next : null;
        const digits  = (typeof info?.digits === 'number') ? info.digits : PAD_DIGITS;
        const s = prompt(`対象プレフィックス: ${prefix}\n現在の桁数: ${digits}\n現在の次番号: ${curNext ?? '(不明)'}\n\n設定したい「次番号」を整数で入力してください`, curNext != null ? String(curNext) : '');
        if (s == null) return;
        const val = parseInt(String(s).replace(/[^\d]/g,''), 10);
        if (!Number.isFinite(val) || val < 0) { alert('整数を入力してください'); return; }
        await setNextSuffixShared(prefix, val);
        setSerialSuffix(val);
        alert(`設定しました。次番号: ${val}（桁=${digits}）`);
      }catch(e){ alert('設定に失敗しました: ' + (e.message || e)); }
    }
    async function configureDigits(){
      if(!prefixReady()){ alert('製造Noのプレフィックス（6桁）が必要です。'); return; }
      const prefix = serverPrefix();
      try{
        const info = await getInfoShared(prefix);
        const cur = (typeof info?.digits === 'number') ? info.digits : PAD_DIGITS;
        const s = prompt(`対象プレフィックス: ${prefix}\n新しい桁数（1〜8）を入力してください`, String(cur));
        if (s == null) return;
        const n = parseInt(String(s).replace(/[^\d]/g,''), 10);
        if (!Number.isFinite(n) || n < 1 || n > 8) { alert('1〜8の整数で入力してください'); return; }
        await setDigitsShared(prefix, n);
        PAD_DIGITS = n;
        const suffix = document.querySelector('input[name="serial_no_suffix"]').value || '';
        if (suffix) setSerialSuffix(parseInt(suffix.replace(/^0+/,'') || '0', 10));
        alert(`桁数を ${n} に設定しました。`);
      }catch(e){ alert('設定に失敗しました: ' + (e.message || e)); }
    }
  </script>
</body>
</html>
